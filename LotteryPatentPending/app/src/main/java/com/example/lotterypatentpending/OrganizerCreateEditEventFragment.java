package com.example.lotterypatentpending;import android.os.Bundle;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.AutoCompleteTextView;import android.widget.Button;import android.widget.EditText;import android.widget.TextView;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.fragment.app.Fragment;import androidx.lifecycle.ViewModelProvider;import androidx.navigation.NavOptions;import androidx.navigation.fragment.NavHostFragment;import com.example.lotterypatentpending.helpers.DateTimeFormatHelper;import com.example.lotterypatentpending.helpers.DateTimePickerHelper;import com.example.lotterypatentpending.helpers.TagDropdownHelper;import com.example.lotterypatentpending.models.Event;import com.example.lotterypatentpending.models.FirebaseManager;import com.example.lotterypatentpending.models.User;import com.example.lotterypatentpending.viewModels.UserEventRepository;import com.example.lotterypatentpending.viewModels.EventViewModel;import com.google.android.material.button.MaterialButton;import com.google.firebase.Timestamp;import android.net.Uri;import android.widget.ImageView;import androidx.activity.result.ActivityResultLauncher;import androidx.activity.result.contract.ActivityResultContracts;/** * Fragment that allows users to create a new Event. * <p> * Collects input from the user, creates an Event object, stores it in Firestore, * and navigates to OrganizerEventViewFragment to display the newly created event. * </p> * @author * @contributor Erik */public class OrganizerCreateEditEventFragment extends Fragment {    private EditText titleEt, descriptionEt, locationEt, capacityEt, waitingListCapEt;    private EditText newTagInput;    private MaterialButton addTagButton;    private AutoCompleteTextView tagDropdown;    private TextView pageTitle, eventDateEt, regStartDateEt, regEndDateEt;    private Button cancelBtn, createEditBtn;    private FirebaseManager fm;    private EventViewModel viewModel;    private ImageView posterPreview;    private Button btnSelectPoster;    private Uri selectedPosterUri = null;    /**     * Inflates the fragment's layout.     *     * @param inflater           The LayoutInflater object that can be used to inflate any views.     * @param container          The parent ViewGroup.     * @param savedInstanceState Bundle containing saved instance state.     * @return The root View of the fragment's layout.     */    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        return inflater.inflate(R.layout.organizer_fragment_create_edit_event, container, false);    }    /**     * Called after the view has been created.     * Initializes UI elements, sets click listeners for buttons.     *     * @param v                  The root view of the fragment.     * @param savedInstanceState Bundle containing saved instance state.     */    @Override    public void onViewCreated(@NonNull View v, @Nullable Bundle savedInstanceState) {        super.onViewCreated(v, savedInstanceState);        //Firebase Manager Instance        fm = FirebaseManager.getInstance();        //Set the views we'll be using        pageTitle = v.findViewById(R.id.pageTitleText);        titleEt = v.findViewById(R.id.titleEt);        tagDropdown = v.findViewById(R.id.tagDropdown);        newTagInput = v.findViewById(R.id.newTagInput);        addTagButton = v.findViewById(R.id.addTagButton);        descriptionEt = v.findViewById(R.id.descriptionEt);        locationEt = v.findViewById(R.id.locationEt);        eventDateEt = v.findViewById(R.id.eventDateEt);        regStartDateEt = v.findViewById(R.id.registrationStartDate);        regEndDateEt = v.findViewById(R.id.registrationEndDate);        capacityEt = v.findViewById(R.id.maxEntrantsInput);        waitingListCapEt = v.findViewById(R.id.waitingListCapInput);        cancelBtn = v.findViewById(R.id.cancelButton);        createEditBtn = v.findViewById(R.id.createEventButton);        viewModel = new ViewModelProvider(requireActivity()).get(EventViewModel.class);        Event passed_event = viewModel.getEvent().getValue();        posterPreview = v.findViewById(R.id.eventImage);        btnSelectPoster = v.findViewById(R.id.btnSelectPoster);        btnSelectPoster.setOnClickListener(view -> {            // open gallery for an image            pickImageLauncher.launch("image/*");        });        if(passed_event != null){            (requireActivity()).setTitle("Edit Event");            pageTitle.setText("Edit Event");            titleEt.setText(passed_event.getTitle());            TagDropdownHelper.setupTagDropdown(requireContext(), tagDropdown, fm);            tagDropdown.setText(passed_event.getTag());            descriptionEt.setText(passed_event.getDescription());            locationEt.setText(passed_event.getLocation());            eventDateEt.setText(DateTimeFormatHelper.formatTimestamp(passed_event.getDate()));            regStartDateEt.setText(DateTimeFormatHelper.formatTimestamp(passed_event.getRegStartDate()));            regEndDateEt.setText(DateTimeFormatHelper.formatTimestamp(passed_event.getRegEndDate()));            capacityEt.setText(String.valueOf(passed_event.getCapacity()));            int wlCap = passed_event.getWaitingListCapacity();            if(wlCap == -1){                waitingListCapEt.setText("N/A");            }else{                waitingListCapEt.setText(passed_event.getWaitingListCapacity());            }            createEditBtn.setText("Save Changes");            createEditBtn.setOnClickListener(view -> {                if (createEditEvent("edit", passed_event)) {                    NavHostFragment.findNavController(OrganizerCreateEditEventFragment.this)                            .navigate(R.id.action_createEditEvent_to_Event_View, null,                                    new NavOptions.Builder()                                            .setPopUpTo(R.id.CreateEditEventFragment, true)                                            .build());                }            }); // removes OrganizerCreateEventFragment from stack so when back is clicked from event view doesn't go back there goes back to page beforehand        }else{            (requireActivity()).setTitle("Create Event");            pageTitle.setText("Create New Event");            createEditBtn.setOnClickListener(view -> {                if (createEditEvent("create", passed_event)) {                    NavHostFragment.findNavController(OrganizerCreateEditEventFragment.this)                            .navigate(R.id.action_createEditEvent_to_Event_View, null,                                    new NavOptions.Builder()                                            .setPopUpTo(R.id.CreateEditEventFragment, true)                                            .build());                }            }); // removes OrganizerCreateEventFragment from stack so when back is clicked from event view doesn't go back there goes back to page beforehand        }        //Attach adapter to tagDropdown        TagDropdownHelper.setupTagDropdown(requireContext(), tagDropdown, fm);        //Add onClickListener for adding tag        addTagButton.setOnClickListener(view -> {            String rawTag = newTagInput.getText().toString().trim();            if (rawTag.isEmpty()) {                Toast.makeText(requireContext(),                        "Please enter a tag name.",                        Toast.LENGTH_SHORT).show();                return;            }            fm.addEventTag(rawTag, new FirebaseManager.FirebaseCallback<Void>() {                @Override                public void onSuccess(Void result) {                    // Clear input                    newTagInput.setText("");                    // Refresh dropdown options                    TagDropdownHelper.setupTagDropdown(requireContext(), tagDropdown, fm);                    // Optionally pre-fill dropdown with the new tag                    // normalized same way as addEventTag                    String normalized = rawTag.substring(0, 1).toUpperCase()                            + rawTag.substring(1).toLowerCase();                    tagDropdown.setText(normalized, false);                    Toast.makeText(requireContext(),                            "Tag added.",                            Toast.LENGTH_SHORT).show();                }                @Override                public void onFailure(Exception e) {                    Toast.makeText(requireContext(),                            "Failed to add tag: " + e.getMessage(),                            Toast.LENGTH_SHORT).show();                }            });        });    // Attach date Dialog and time Dialog for each TextView date        DateTimePickerHelper.attachDateTimePicker(eventDateEt, requireContext());        DateTimePickerHelper.attachDateTimePicker(regStartDateEt, requireContext());        DateTimePickerHelper.attachDateTimePicker(regEndDateEt, requireContext());        cancelBtn.setOnClickListener(view ->                NavHostFragment.findNavController(OrganizerCreateEditEventFragment.this)                        .popBackStack());    }    /**     * Collects input from EditText/TextViews fields, creates a new Event object,     * saves it to Firestore, and updates the EventViewModel.     */    public boolean createEditEvent(String action, Event passed_event) {        String title = titleEt.getText().toString().trim();        String tag = tagDropdown.getText().toString().trim();        String description = descriptionEt.getText().toString().trim();        String location = locationEt.getText().toString().trim();        String eventDateString = eventDateEt.getText().toString().trim();        String regStartDateString = regStartDateEt.getText().toString().trim();        String regEndDateString = regEndDateEt.getText().toString().trim();        String capacityString = capacityEt.getText().toString().trim();        String waitingListCapString= waitingListCapEt.getText().toString().trim();        // Basic required fields        if (title.isEmpty() || description.isEmpty()) {            Toast.makeText(requireContext(),                    "Title and description are required.",                    Toast.LENGTH_SHORT).show();            return false;        }        if(location.isEmpty()){location = null;}        // Dates required (strings)        if (eventDateString.isEmpty() || regStartDateString.isEmpty() || regEndDateString.isEmpty()) {            Toast.makeText(requireContext(),                    "Event date, registration start, and registration end are required.",                    Toast.LENGTH_SHORT).show();            return false;        }        // Capacity required and must be a number        if (capacityString.isEmpty()) {            Toast.makeText(requireContext(),                    "Event capacity is required.",                    Toast.LENGTH_SHORT).show();            return false;        }        int capacity;        try {            capacity = Integer.parseInt(capacityString);        } catch (NumberFormatException e) {            Toast.makeText(requireContext(),                    "Capacity must be a number.",                    Toast.LENGTH_SHORT).show();            return false;        }        int waitingListCap = -1;        if (!waitingListCapString.equalsIgnoreCase("N/A") &&                !waitingListCapString.isEmpty()) {            try {                waitingListCap = Integer.parseInt(waitingListCapString);            } catch (NumberFormatException e) {                Toast.makeText(requireContext(),                        "Waiting list cap must be a number or 'N/A'.",                        Toast.LENGTH_SHORT).show();                return false;            }        }        // Parse timestamps        Timestamp eventDate = DateTimeFormatHelper.parseTimestamp(eventDateString);        Timestamp regStartDate = DateTimeFormatHelper.parseTimestamp(regStartDateString);        Timestamp regEndDate = DateTimeFormatHelper.parseTimestamp(regEndDateString);        // Parsing failed -> invalid date format        if (eventDate == null || regStartDate == null || regEndDate == null) {            Toast.makeText(requireContext(),                    "Please select valid dates and times.",                    Toast.LENGTH_SHORT).show();            return false;        }        // Registration window rules        if (!validateRegistrationWindow(eventDate, regStartDate, regEndDate)) {            return false;        }        // Get the current user        User current_user = UserEventRepository.getInstance().getUser().getValue();        if (current_user == null) {            Toast.makeText(requireContext(),                    "No current user logged in.",                    Toast.LENGTH_SHORT).show();            return false;        }        if(action.equals("create") && passed_event == null){            // Create the new event            Event newEvent = new Event(title, description, capacity, current_user);            newEvent.setTag(tag);            newEvent.setLocation(location);            newEvent.setDate(eventDate);            newEvent.setRegStartDate(regStartDate);            newEvent.setRegEndDate(regEndDate);            newEvent.setWaitingListCapacity(waitingListCap);            // Save to Firestore            fm.addEventToDB(newEvent);            viewModel.setEvent(newEvent);            if (selectedPosterUri != null) {                fm.uploadEventPoster(newEvent.getId(), selectedPosterUri, new FirebaseManager.FirebaseCallback<String>() {                    @Override                    public void onSuccess(String result) {                        // Optional: show toast                        Toast.makeText(requireContext(),                                "Poster uploaded", Toast.LENGTH_SHORT).show();                    }                    @Override                    public void onFailure(Exception e) {                        Toast.makeText(requireContext(),                                "Failed to upload poster: " + e.getMessage(),                                Toast.LENGTH_SHORT).show();                    }                });            }        }else if(action.equals("edit") && passed_event != null){            passed_event.setTitle(title);            passed_event.setDescription(description);            passed_event.setTag(tag);            passed_event.setLocation(location);            passed_event.setDate(eventDate);            passed_event.setRegStartDate(regStartDate);            passed_event.setRegEndDate(regEndDate);            passed_event.setCapacity(capacity);            passed_event.setWaitingListCapacity(waitingListCap);            fm.addOrUpdateEvent(passed_event.getId(), passed_event);            viewModel.setEvent(passed_event);            if (selectedPosterUri != null) {                fm.uploadEventPoster(passed_event.getId(), selectedPosterUri, new FirebaseManager.FirebaseCallback<String>() {                    @Override                    public void onSuccess(String result) {                        Toast.makeText(requireContext(),                                "Poster updated", Toast.LENGTH_SHORT).show();                    }                    @Override                    public void onFailure(Exception e) {                        Toast.makeText(requireContext(),                                "Failed to upload poster: " + e.getMessage(),                                Toast.LENGTH_SHORT).show();                    }                });            }        }        // Update EventViewModel for sharing with OrganizerEventViewFragment        return true;    }    /**     *     * @param eventDate timestamp of the events date     * @param regStart timestamp of the registration start date     * @param regEnd timestamp of the registration end date     * @return true/false if timestamps are validated and make sense.     */    private boolean validateRegistrationWindow(Timestamp eventDate,                                               Timestamp regStart,                                               Timestamp regEnd) {        if (eventDate == null || regStart == null || regEnd == null) {            Toast.makeText(requireContext(),                    "Please set event date, registration start, and registration end.",                    Toast.LENGTH_SHORT).show();            return false;        }        // regEnd must be AFTER regStart (strict)        if (regEnd.compareTo(regStart) <= 0) {            Toast.makeText(requireContext(),                    "Registration end must be after registration start.",                    Toast.LENGTH_SHORT).show();            return false;        }        // regEnd must NOT be after eventDate        if (regEnd.compareTo(eventDate) > 0) {            Toast.makeText(requireContext(),                    "Registration must end before the event starts.",                    Toast.LENGTH_SHORT).show();            return false;        }        return true;    }    private final ActivityResultLauncher<String> pickImageLauncher =            registerForActivityResult(new ActivityResultContracts.GetContent(),                    uri -> {                        if (uri != null) {                            selectedPosterUri = uri;                            if (posterPreview != null) {                                posterPreview.setImageURI(uri);                                posterPreview.setVisibility(View.VISIBLE);                            }                        }                    });}